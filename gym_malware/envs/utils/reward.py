import ctypes
import json
import os
import random
import sqlite3
import subprocess
import sys
import tempfile
import time

import pyclamd
from config import *

from gym_malware.envs.utils.engine import Engine

module_path = os.path.abspath(os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(__file__)))))
this_path = os.path.abspath(os.path.dirname(__file__))
ENGINE_TABLE = {
    'clamav': 'ClamAV',
    'kaspersky': 'Kaspersky',
    'fsecure': 'FSecure',
    'mcafee': 'McAfee'
}
# clamav
class ClamAV(Engine):
    def __init__(self):
        # 对抗检测引擎的路径
        self.clamav_root = "D:\ClamAV"

    def scan(self, path):
        result = subprocess.getoutput(self.clamav_root + '\\clamdscan --no-summary ' + path)
        print(result)
        with open(os.path.join(LOG_PATH, "log.txt"), "a+") as f:
            f.write(str(result) + "\n")
        return 0 if result.split()[-1] == "OK" else 1

class FSecure(Engine):
    def __init__(self):
        super().__init__()

    def scan(self, sample):
        result = subprocess.getoutput("fsav --virus-action1=report --suspected-action1=report " + sample)
        print(result)
        return 1 if result.split()[-1] == "infected" else 0

class McAfee(Engine):
    def __init__(self):
        self.mcafee_root = "/home/fangzhiyang/engines/mcafee/uvscan"
        super().__init__()

    def scan(self, sample):
        result = subprocess.getoutput(self.mcafee_root + " " + sample)
        print(result)
        return 1 if "Found the" in result else 0

# windows defender
class Microsoft(Engine):
    def __init__(self):
        self.detector_path = "%ProgramFiles%\\Windows Defender"
        super().__init__()

    def scan(self, path):
       try:
            command = '"' + self.detector_path + '\\MpCmdRun.exe" -Scan -ScanType 3 -File "' + path + '" -DisableRemediation'
            result = subprocess.getoutput(command)
            return self.__parse(result)
       except:
           return "检测失败"

    def __parse(self, result):
        return 0 if "found no threats" in result else 1

# Kaspersky
class Kaspersky(Engine):
    def __init__(self):
        self.detector_path = "C:\\Program Files (x86)\\Kaspersky Lab\\Kaspersky Anti-Virus 21.3"
        super().__init__()

    def scan(self, path):
        try:
            command = '"' + self.detector_path + '\\avp.com" scan /i0 ' + '"' + path + '"'
            result = subprocess.getoutput(command)
            print(result)
            return self.__parse(result)
        except:
            return "检测失败"

    def __parse(self, result):
        return 0 if "Total OK:	1" in result else 1

# 火绒
class HuoRong(Engine):
    def __init__(self):
        # 加载窗口处理dll
        pDLL = None
        try:
            pDLL = ctypes.WinDLL(r"lib\huorong.dll")
        except:
            try:
                pDLL = ctypes.WinDLL(r"lib\huorong_64.dll")
            except:
                print("Load Native Library Error.")
        self.getHandle = pDLL.getHandle
        self.click = pDLL.click

        super().__init__()

    def scan(self, path):
        class LogDB:
            def __init__(self):
                self.db = sqlite3.connect(r"C:\ProgramData\Huorong\Sysdiag\log.db")

            def get_current_id(self):
                return self.db.execute("select max(id) from HrLogV3 where fname='scan'").fetchone()[0]

            def get_detail_by_id(self, id):
                return self.db.execute("select detail from HrLogV3 where id = {}".format(id)).fetchone()[0]

        try:
            self.log_db = LogDB()
            current_id = self.log_db.get_current_id()
            command = "\"C:\Program Files (x86)\Huorong\Sysdiag\\bin\HipsMain.exe\" -s {}".format(path)
            subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
            while True:
                handle = self.getHandle()
                if handle != -1:
                    break
            while True:
                self.click(handle, 655, 40)
                next_id = self.log_db.get_current_id()
                if next_id != current_id:
                    break
                time.sleep(0.5)
            result = self.log_db.get_detail_by_id(next_id)
            return self.__parse(result)
        except:
            return "检测失败"

    def __parse(self, result):
        return 0 if json.loads(result)["detail"]["threats"] == 0 else 1


def label_function(engine, sample):
    tmpfilename = os.path.join(
        tempfile._get_default_tempdir(),
        next(tempfile._get_candidate_names()),
    )
    with open(tmpfilename, "wb") as f:  # 写文件时指定模式为"b"
        f.write(sample)
    result = engine.scan(tmpfilename)
    os.unlink(tmpfilename)
    return result


if __name__ == '__main__':
    # ca = ClamAV()
    fsav = FSecure()
    sample_path = MAL_SAMPLE_PATH
    with open(sample_path, 'rb') as sp:
        sample = sp.read()
    # print(kpsk.scan(sample_path))
    print(label_function(fsav, sample))
    # defender = Microsoft()
    # print(defender.scan(r'd:/samples/rootkit/Rootkit.Win32.Agent.acq'))


