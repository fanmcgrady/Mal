import glob
import os
import subprocess
import sys

from gym_malware.envs.utils import pefeatures

class Reward():
    def __init__(self):
        # 对抗检测引擎的路径
        self.clamav_root = "C:\\engines\\ClamAV\\clamav-0.105.0-rc.win.x64"

    # 启动检测守护进程
    def run_detect_daemon(self):
        # The necessary work before detection is to open a daemon, Clamd, for detection
        p = subprocess.Popen(self.clamav_root + '\\clamd', shell=True, stdout=subprocess.PIPE,
                             stderr=subprocess.STDOUT,
                             encoding='gb2312')
        # 有输出才启动成功
        for i in iter(p.stdout.readline, 'b'):
            if i is not None:
                break

    def scan(self, path):
        result = subprocess.getoutput(self.clamav_root + '\\clamdscan --no-summary ' + path)
        print(result)
        return "正常文件" if result.split()[-1] == "OK" else "恶意文件"

if __name__ == '__main__':
    sample = r"C:\Users\fanmc\Desktop\samples\notepad.exe"
    reward = Reward()
    reward.run_detect_daemon()
    print(reward.scan(sample))